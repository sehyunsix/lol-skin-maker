<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나만의 롤 스킨 만들기 (LoL Skin Creator)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #0a0a12; /* LoL Dark Theme */
            color: #c8aa6e; /* LoL Gold Text */
        }
        .gold-border {
            border: 1px solid #c8aa6e;
        }
        .hextech-bg {
            background: linear-gradient(135deg, #1e2328 0%, #0a0a12 100%);
        }
        .champion-grid::-webkit-scrollbar {
            width: 8px;
        }
        .champion-grid::-webkit-scrollbar-track {
            background: #0a0a12;
        }
        .champion-grid::-webkit-scrollbar-thumb {
            background: #463714;
            border-radius: 4px;
        }
        .champion-grid::-webkit-scrollbar-thumb:hover {
            background: #c8aa6e;
        }
        .loading-spinner {
            border: 4px solid rgba(200, 170, 110, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #c8aa6e;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-[#111] border-b border-[#463714] p-4 flex justify-center items-center shadow-lg relative z-10">
        <div class="flex items-center gap-3">
            <i data-lucide="gamepad-2" class="w-8 h-8 text-[#c8aa6e]"></i>
            <h1 class="text-2xl font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-b from-[#f0e6d2] to-[#c8aa6e]">
                나만의 LoL 스킨 제작소
            </h1>
        </div>
    </header>

    <main class="flex-1 flex flex-col lg:flex-row max-w-7xl mx-auto w-full p-4 gap-6">
        
        <!-- Left Panel: Champion Selection -->
        <section class="w-full lg:w-1/3 bg-[#1e2328] border border-[#463714] rounded-lg overflow-hidden flex flex-col h-[500px] lg:h-[800px] shadow-2xl">
            <div class="p-4 border-b border-[#463714] bg-[#111]">
                <h2 class="text-lg font-bold mb-2 flex items-center gap-2">
                    <i data-lucide="search" class="w-5 h-5"></i> 챔피언 선택
                </h2>
                <input type="text" id="search-input" placeholder="챔피언 이름 검색 (예: 가렌, 아리)" 
                    class="w-full bg-[#0a0a12] border border-[#463714] text-[#f0e6d2] p-2 rounded focus:outline-none focus:border-[#c8aa6e] placeholder-gray-600">
            </div>
            
            <div id="champion-list" class="champion-grid overflow-y-auto p-4 grid grid-cols-4 gap-3 flex-1 content-start">
                <!-- Champions will be loaded here -->
                <div class="col-span-4 flex justify-center py-10">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </section>

        <!-- Right Panel: Workspace -->
        <section class="w-full lg:w-2/3 flex flex-col gap-6">
            
                <!-- Controls -->
                <div class="bg-[#1e2328] border border-[#463714] rounded-lg p-6 shadow-2xl">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-[#f0e6d2]">
                        <i data-lucide="wand-2" class="w-6 h-6 text-[#c8aa6e]"></i> 스킨 제작 작업대
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Step 1: Upload (이제 숨김 - 아래 내 사진 영역에 통합됨) -->
                        <div class="hidden"></div>

                        <!-- Step 2: Adjustments -->
                        <div class="flex flex-col gap-4 justify-center">
                            <div class="bg-[#0a0a12] p-3 rounded border border-[#463714]">
                                <div class="flex justify-between mb-1">
                                    <span class="text-xs text-gray-400">합성 강도 (Opacity)</span>
                                    <span id="opacity-val" class="text-xs text-[#c8aa6e]">70%</span>
                                </div>
                                <input type="range" id="opacity-slider" min="0" max="100" value="70" class="w-full accent-[#c8aa6e]">
                            </div>

                            <!-- Blend Mode Selection -->
                            <div class="bg-[#0a0a12] p-3 rounded border border-[#463714]">
                                <div class="mb-2">
                                    <span class="text-xs text-gray-400">합성 모드</span>
                                </div>
                                <select id="blend-mode" class="w-full bg-[#1e2328] border border-[#463714] text-[#c8aa6e] p-2 rounded text-xs focus:outline-none focus:border-[#c8aa6e]">
                                    <option value="multiply">Multiply (어두운 합성)</option>
                                    <option value="screen">Screen (밝은 합성)</option>
                                    <option value="overlay">Overlay (중간 합성)</option>
                                    <option value="add">Add (더하기)</option>
                                    <option value="lighten">Lighten (밝음 선택)</option>
                                    <option value="darken">Darken (어두움 선택)</option>
                                </select>
                            </div>
                            
                            <button id="generate-btn" class="w-full bg-gradient-to-r from-[#c8aa6e] to-[#917436] text-[#0a0a12] font-bold py-3 px-4 rounded shadow-lg hover:scale-[1.02] active:scale-95 transition-transform flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="swords" class="w-5 h-5"></i>
                                스킨 생성하기
                            </button>
                        </div>
                    </div>
                </div>

            <!-- Result Area -->
            <div class="flex-1 bg-[#0a0a12] border border-[#463714] rounded-lg p-4 flex flex-col relative">
                
                <!-- Preview Row: 내 사진 + 챔피언 사진 -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <!-- My Photo Preview with Upload -->
                    <div class="flex flex-col items-center">
                        <h3 class="text-sm font-bold text-[#c8aa6e] mb-2 flex items-center gap-1">
                            <i data-lucide="user" class="w-4 h-4"></i> 내 사진
                        </h3>
                        <label for="image-upload" class="w-full cursor-pointer group">
                            <div id="my-photo-container" class="w-full aspect-square bg-[#1e2328] border-2 border-[#463714] rounded-lg overflow-hidden flex items-center justify-center relative group-hover:border-[#c8aa6e] group-hover:bg-[#0a0a12] transition-colors">
                                <img id="my-photo-preview" src="" alt="My Photo" class="w-full h-full object-cover hidden">
                                <div id="my-photo-placeholder" class="flex flex-col items-center justify-center text-gray-500 absolute inset-0 group-hover:bg-black/20 transition-colors">
                                    <i data-lucide="upload-cloud" class="w-10 h-10 mb-2 opacity-50 group-hover:opacity-100 group-hover:text-[#c8aa6e] transition-all"></i>
                                    <p class="text-xs text-center text-gray-400 group-hover:text-[#f0e6d2] transition-colors">클릭하여 사진 선택</p>
                                </div>
                            </div>
                        </label>
                        <input id="image-upload" type="file" class="hidden" accept="image/*" />
                    </div>

                    <!-- Champion Photo Preview -->
                    <div class="flex flex-col items-center">
                        <h3 class="text-sm font-bold text-[#c8aa6e] mb-2 flex items-center gap-1">
                            <i data-lucide="star" class="w-4 h-4"></i> 챔피언
                        </h3>
                        <div id="champion-photo-container" class="w-full aspect-square bg-[#1e2328] border-2 border-[#463714] rounded-lg overflow-hidden flex items-center justify-center relative">
                            <img id="champion-photo-preview" src="" alt="Champion" class="w-full h-full object-cover hidden">
                            <div id="champion-photo-placeholder" class="flex flex-col items-center justify-center text-gray-500">
                                <i data-lucide="crown" class="w-8 h-8 mb-2 opacity-50"></i>
                                <p class="text-xs text-center">챔피언 선택 대기 중</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generated Skin Canvas -->
                <div class="flex-1 flex flex-col items-center">
                    <h3 class="text-sm font-bold text-[#c8aa6e] mb-2 flex items-center gap-1 w-full">
                        <i data-lucide="sparkles" class="w-4 h-4"></i> 생성된 스킨
                    </h3>
                    <div id="canvas-container" class="relative shadow-2xl border-4 border-[#1e2328] rounded-lg overflow-hidden flex-1 flex items-center justify-center w-full">
                        <canvas id="skin-canvas" class="max-w-full h-auto"></canvas>
                        
                        <!-- Placeholder Text -->
                        <div id="placeholder-text" class="absolute inset-0 flex flex-col items-center justify-center text-gray-600 bg-[#0f1115]">
                            <i data-lucide="image-plus" class="w-12 h-12 mb-2 opacity-50"></i>
                            <p>챔피언을 선택하고 사진을 올려주세요</p>
                        </div>
                    </div>

                    <div id="download-area" class="mt-4 hidden">
                        <button id="download-btn" class="bg-[#1e2328] border border-[#c8aa6e] text-[#c8aa6e] py-2 px-6 rounded hover:bg-[#c8aa6e] hover:text-[#0a0a12] transition-colors flex items-center gap-2 font-bold">
                            <i data-lucide="download" class="w-5 h-5"></i>
                            이미지 저장
                        </button>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <script>
        // --- Initialize Icons ---
        lucide.createIcons();

        // --- Constants & State ---
        const DDRAGON_VERSION = "13.24.1"; // 버전은 주기적으로 업데이트 필요
        const DATA_URL = `https://ddragon.leagueoflegends.com/cdn/${DDRAGON_VERSION}/data/ko_KR/champion.json`;
        const IMG_URL = `https://ddragon.leagueoflegends.com/cdn/img/champion/loading/`; // 로딩 스크린 이미지 사용

        let championsData = {};
        let selectedChampion = null;
        let userImageFile = null;
        let userImageObj = null;

        // --- Elements ---
        const championListEl = document.getElementById('champion-list');
        const searchInput = document.getElementById('search-input');
        const fileInput = document.getElementById('image-upload');
        const canvas = document.getElementById('skin-canvas');
        const ctx = canvas.getContext('2d');
        const generateBtn = document.getElementById('generate-btn');
        const opacitySlider = document.getElementById('opacity-slider');
        const opacityVal = document.getElementById('opacity-val');
        const downloadArea = document.getElementById('download-area');
        const downloadBtn = document.getElementById('download-btn');
        const placeholderText = document.getElementById('placeholder-text');
        
        // --- New Preview Elements ---
        const myPhotoPreview = document.getElementById('my-photo-preview');
        const myPhotoPlaceholder = document.getElementById('my-photo-placeholder');
        const championPhotoPreview = document.getElementById('champion-photo-preview');
        const championPhotoPlaceholder = document.getElementById('champion-photo-placeholder');

        // --- 1. Fetch Champions ---
        async function loadChampions() {
            try {
                const response = await fetch(DATA_URL);
                const data = await response.json();
                championsData = Object.values(data.data);
                renderChampions(championsData);
            } catch (error) {
                console.error("Failed to load champions:", error);
                championListEl.innerHTML = `<div class="col-span-4 text-center text-red-500">챔피언 데이터를 불러오는데 실패했습니다.</div>`;
            }
        }

        // --- 2. Render Champions ---
        function renderChampions(list) {
            championListEl.innerHTML = '';
            
            list.sort((a, b) => a.name.localeCompare(b.name)); // 이름순 정렬

            list.forEach(champ => {
                const div = document.createElement('div');
                div.className = 'cursor-pointer hover:scale-105 transition-transform relative group';
                div.onclick = () => selectChampion(champ);
                
                const imgUrl = `https://ddragon.leagueoflegends.com/cdn/${DDRAGON_VERSION}/img/champion/${champ.id}.png`;
                
                div.innerHTML = `
                    <div class="aspect-square rounded overflow-hidden border-2 border-[#463714] group-hover:border-[#c8aa6e] transition-colors">
                        <img src="${imgUrl}" alt="${champ.name}" class="w-full h-full object-cover" loading="lazy">
                    </div>
                    <div class="text-xs text-center mt-1 text-gray-400 group-hover:text-[#f0e6d2] truncate">${champ.name}</div>
                `;
                championListEl.appendChild(div);
            });
        }

        // --- 3. Search Logic ---
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = championsData.filter(c => 
                c.name.toLowerCase().includes(term) || 
                c.id.toLowerCase().includes(term)
            );
            renderChampions(filtered);
        });

        // --- 4. Selection Logic ---
        function selectChampion(champ) {
            selectedChampion = champ;
            
            // UI Update: Highlight selected
            const allItems = championListEl.children;
            for (let item of allItems) {
                item.children[0].classList.remove('ring-2', 'ring-[#c8aa6e]', 'ring-offset-2', 'ring-offset-[#1e2328]');
            }
            
            // 챔피언 사진 표시
            displayChampionPhoto(champ);
            
            // 캔버스 미리보기 업데이트
            updateCanvasPreview();
        }
        
        // 챔피언 사진 표시 함수
        function displayChampionPhoto(champ) {
            const champImgUrl = `https://ddragon.leagueoflegends.com/cdn/${DDRAGON_VERSION}/img/champion/${champ.id}.png`;
            
            championPhotoPreview.src = champImgUrl;
            championPhotoPreview.style.display = 'block';
            championPhotoPlaceholder.style.display = 'none';
        }

        // --- 5. File Upload Logic ---
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                userImageFile = file; // 파일 저장 (서버 전송용)
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        userImageObj = img;
                        
                        // 내 사진 미리보기 표시
                        myPhotoPreview.src = event.target.result;
                        myPhotoPreview.style.display = 'block';
                        myPhotoPreview.style.zIndex = '10';
                        myPhotoPlaceholder.style.display = 'none';
                        myPhotoPlaceholder.style.zIndex = '0';
                        
                        updateCanvasPreview();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // --- 6. Canvas Drawing Logic (The "Mixing") ---
        function updateCanvasPreview() {
            if (!selectedChampion) return;

            placeholderText.style.display = 'none';
            
            // 로딩 스크린 이미지 (세로형)
            const champImgUrl = `${IMG_URL}${selectedChampion.id}_0.jpg`;
            
            const bgImg = new Image();
            bgImg.crossOrigin = "Anonymous"; // 필수: 캔버스 오염 방지
            bgImg.src = champImgUrl;

            bgImg.onload = () => {
                // Canvas 크기 설정 (로딩 스크린 비율: 308x560)
                canvas.width = 308;
                canvas.height = 560;

                // 1. Draw Champion (Background)
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1.0;
                ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);

                // 2. Draw User Image (Overlay/Blend) with better blending
                if (userImageObj) {
                    const opacity = opacitySlider.value / 100;
                    
                    // Center and crop/fit user image
                    const ratio = Math.max(canvas.width / userImageObj.width, canvas.height / userImageObj.height);
                    const centerShift_x = (canvas.width - userImageObj.width * ratio) / 2;
                    const centerShift_y = (canvas.height - userImageObj.height * ratio) / 2;

                    // Try better blend modes: 'lighten', 'screen', 'add', 'multiply'
                    ctx.globalCompositeOperation = 'multiply'; // 이미지 어둡게 겹치기
                    ctx.globalAlpha = opacity * 0.6;

                    ctx.drawImage(userImageObj, 
                        0, 0, userImageObj.width, userImageObj.height,
                        centerShift_x, centerShift_y, userImageObj.width * ratio, userImageObj.height * ratio
                    );

                    // 추가 레이어: 더 밝은 오버레이
                    ctx.globalCompositeOperation = 'screen'; // 이미지 밝게 겹치기
                    ctx.globalAlpha = opacity * 0.4;

                    ctx.drawImage(userImageObj, 
                        0, 0, userImageObj.width, userImageObj.height,
                        centerShift_x, centerShift_y, userImageObj.width * ratio, userImageObj.height * ratio
                    );

                    // 3. Apply Hextech Gold tint
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.globalAlpha = 0.15;
                    ctx.fillStyle = '#c8aa6e';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }

                // 4. Draw Border/Frame Effect
                ctx.globalCompositeOperation = 'source-over';
                ctx.globalAlpha = 1.0;
                
                // Simple Vignette
                const gradient = ctx.createRadialGradient(canvas.width/2, canvas.height/2, canvas.width/3, canvas.width/2, canvas.height/2, canvas.height);
                gradient.addColorStop(0, "transparent");
                gradient.addColorStop(1, "rgba(0,0,0,0.6)");
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Text: Champion Name
                ctx.font = "bold 24px 'Noto Sans KR'";
                ctx.fillStyle = "#f0e6d2";
                ctx.textAlign = "center";
                ctx.shadowColor = "black";
                ctx.shadowBlur = 10;
                ctx.fillText(selectedChampion.name, canvas.width / 2, canvas.height - 40);
                
                ctx.font = "14px 'Noto Sans KR'";
                ctx.fillStyle = "#c8aa6e";
                ctx.fillText("CUSTOM SKIN", canvas.width / 2, canvas.height - 20);

                downloadArea.classList.remove('hidden');
            };

            bgImg.onerror = () => {
                console.error("챔피언 이미지 로드 실패:", champImgUrl);
                alert("챔피언 이미지를 불러올 수 없습니다. 다시 시도해주세요.");
            };
        }

        // --- Event Listeners ---
        generateBtn.addEventListener('click', async () => {
            if(!selectedChampion) {
                alert("먼저 챔피언을 선택해주세요!");
                return;
            }
            
            if(!userImageObj) {
                alert("먼저 사진을 업로드해주세요!");
                return;
            }

            // 로컬 캔버스로 먼저 미리보기
            updateCanvasPreview();

            // 백엔드로 스킨 생성 요청
            if(userImageFile) {
                await generateSkinWithAI();
            }
        });

        // AI 기반 스킨 생성 함수
        async function generateSkinWithAI() {
            try {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<div class="loading-spinner" style="width:20px; height:20px; display:inline-block; margin-right:8px;"></div>AI 스킨 생성 중...';
                
                const formData = new FormData();
                formData.append('image', userImageFile);
                formData.append('champion', selectedChampion.name);

                const response = await fetch('/api/generate-skin', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '스킨 생성 실패');
                }

                const result = await response.json();
                
                if (result.success) {
                    // 생성된 이미지 표시
                    showGeneratedSkin(result.url);
                    alert('스킨이 성공적으로 생성되었습니다!');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('AI 스킨 생성 오류:', error);
                alert('스킨 생성 중 오류가 발생했습니다: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i data-lucide="swords" class="w-5 h-5"></i> 스킨 생성하기';
                lucide.createIcons();
            }
        }

        // 생성된 스킨 이미지 표시
        function showGeneratedSkin(imageUrl) {
            const canvasContainer = document.getElementById('canvas-container');
            
            // 기존 캔버스 숨기기
            canvas.style.display = 'none';
            
            // 새 이미지 요소 생성 (또는 기존 이미지 업데이트)
            let generatedImg = canvasContainer.querySelector('img.generated-skin');
            if (!generatedImg) {
                generatedImg = document.createElement('img');
                generatedImg.className = 'generated-skin max-w-full h-auto border-4 border-[#1e2328] rounded-lg';
                canvasContainer.appendChild(generatedImg);
            }
            
            generatedImg.src = imageUrl;
            generatedImg.style.display = 'block';
        }

        opacitySlider.addEventListener('input', (e) => {
            opacityVal.innerText = `${e.target.value}%`;
            updateCanvasPreview();
        });

        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `${selectedChampion ? selectedChampion.name : 'custom'}_skin.png`;
            link.href = canvas.toDataURL();
            link.click();
        });

        // Start
        loadChampions();

    </script>
</body>
</html>